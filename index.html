<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Tickets Freshdesk - AFJ Global</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .header-title h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header-title p {
            font-size: 16px;
            opacity: 0.9;
        }

        .live-badge {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .live-badge::before {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(16, 185, 129, 0.7);
            }
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .year-selector {
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .year-selector:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .update-btn {
            padding: 10px 25px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .update-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .update-btn:active {
            transform: translateY(0);
        }

        .last-update {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .content {
            padding: 30px 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card.baja {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card.media {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card.alta {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }

        .search-box {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #64748b;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tickets-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .tickets-container::-webkit-scrollbar {
            width: 8px;
        }

        .tickets-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .tickets-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .tickets-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .ticket-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transform: translateX(5px);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .ticket-id {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .ticket-priority {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .ticket-priority.baja {
            background: #d1fae5;
            color: #059669;
        }

        .ticket-priority.media {
            background: #fed7aa;
            color: #d97706;
        }

        .ticket-priority.alta {
            background: #fee2e2;
            color: #dc2626;
        }

        .ticket-subject {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #64748b;
        }

        .ticket-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
            font-size: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .recurrence-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .recurrence-table th,
        .recurrence-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .recurrence-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .recurrence-table tr:hover {
            background: #f8fafc;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            font-size: 14px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .metric-card h4 {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metric-card .value {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .metric-card .label {
            font-size: 13px;
            color: #94a3b8;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .breakdown-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .breakdown-item.baja {
            border-left-color: #10b981;
        }

        .breakdown-item.media {
            border-left-color: #f59e0b;
        }

        .breakdown-item.alta {
            border-left-color: #ef4444;
        }

        .breakdown-item h5 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .breakdown-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
        }

        .breakdown-item .percentage {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .heatmap-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .heatmap-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
            font-size: 20px;
        }

        .heatmap-canvas {
            width: 100%;
            height: 300px;
            border-radius: 10px;
        }

        .trend-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .trend-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .trend-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .trend-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .trend-card .subtitle {
            font-size: 13px;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '';
            }
            40% {
                content: '.';
            }
            60% {
                content: '..';
            }
            80%, 100% {
                content: '...';
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 16px;
        }

        .pie-chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .pie-chart-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .header-title h1 {
                font-size: 24px;
            }

            .content {
                padding: 20px;
            }

            .tab {
                padding: 12px 15px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="header-title">
                    <h1>üé´ Visor de Tickets Freshdesk</h1>
                    <p>AFJ Global | Tiempo Real</p>
                </div>
                <div class="live-badge">EN VIVO</div>
            </div>
            <div class="controls">
                <select class="year-selector" id="yearSelector">
                    <option value="all">Todos los a√±os</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                </select>
                <button class="update-btn" onclick="refreshData()">üîÑ Actualizar</button>
            </div>
            <div class="last-update" id="lastUpdate">√öltima actualizaci√≥n: --</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üìä Todos los Tickets</button>
            <button class="tab" onclick="switchTab(1)">üîÅ An√°lisis de Recurrencia</button>
            <button class="tab" onclick="switchTab(2)">‚ö†Ô∏è An√°lisis por Criticidad</button>
            <button class="tab" onclick="switchTab(3)">üìà M√©tricas de Rendimiento (KPIs)</button>
            <button class="tab" onclick="switchTab(4)">üìä An√°lisis de Tendencias y Carga</button>
        </div>

        <div class="content">
            <!-- Tab 1: Todos los Tickets -->
            <div class="tab-content active" id="tab0">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Tickets</h3>
                        <div class="number" id="totalTickets">0</div>
                    </div>
                    <div class="stat-card baja">
                        <h3>Prioridad Baja</h3>
                        <div class="number" id="bajaCount">0</div>
                    </div>
                    <div class="stat-card media">
                        <h3>Prioridad Media</h3>
                        <div class="number" id="mediaCount">0</div>
                    </div>
                    <div class="stat-card alta">
                        <h3>Prioridad Alta</h3>
                        <div class="number" id="altaCount">0</div>
                    </div>
                </div>

                <input type="text" class="search-box" id="searchBox" placeholder="üîç Buscar por asunto, descripci√≥n o ID...">

                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByPriority('all')">Todos</button>
                    <button class="filter-btn" onclick="filterByPriority('baja')">üü¢ Baja</button>
                    <button class="filter-btn" onclick="filterByPriority('media')">üü° Media</button>
                    <button class="filter-btn" onclick="filterByPriority('alta')">üî¥ Alta</button>
                </div>

                <div class="tickets-container" id="ticketsContainer">
                    <div class="loading">Cargando tickets</div>
                </div>
            </div>

            <!-- Tab 2: An√°lisis de Recurrencia -->
            <div class="tab-content" id="tab1">
                <div class="chart-container">
                    <h3>Top 20 Tickets M√°s Recurrentes</h3>
                    <div class="chart-wrapper">
                        <canvas id="recurrenceChart"></canvas>
                    </div>
                </div>

                <table class="recurrence-table" id="recurrenceTable">
                    <thead>
                        <tr>
                            <th>Ranking</th>
                            <th>Asunto</th>
                            <th>Cantidad</th>
                            <th>Porcentaje</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px;">
                                <div class="loading">Cargando datos de recurrencia</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Tab 3: An√°lisis por Criticidad -->
            <div class="tab-content" id="tab2">
                <div class="pie-chart-grid">
                    <div class="chart-container">
                        <h3>Distribuci√≥n por Criticidad</h3>
                        <div class="chart-wrapper">
                            <canvas id="criticalityChart"></canvas>
                        </div>
                    </div>

                    <div>
                        <div class="breakdown-grid">
                            <div class="breakdown-item alta">
                                <h5>ALTA</h5>
                                <div class="value" id="criticalityAltaCount">0</div>
                                <div class="percentage" id="criticalityAltaPercent">0%</div>
                            </div>
                            <div class="breakdown-item media">
                                <h5>MEDIA</h5>
                                <div class="value" id="criticalityMediaCount">0</div>
                                <div class="percentage" id="criticalityMediaPercent">0%</div>
                            </div>
                            <div class="breakdown-item baja">
                                <h5>BAJA</h5>
                                <div class="value" id="criticalityBajaCount">0</div>
                                <div class="percentage" id="criticalityBajaPercent">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: M√©tricas (KPIs) -->
            <div class="tab-content" id="tab3">
                <div class="metric-grid">
                    <div class="metric-card">
                        <h4>Total Tickets</h4>
                        <div class="value" id="kpiTotal">0</div>
                        <div class="label">Todos los tickets</div>
                    </div>
                    <div class="metric-card">
                        <h4>Tickets Cerrados</h4>
                        <div class="value" id="kpiClosed">0</div>
                        <div class="label">Resueltos</div>
                    </div>
                    <div class="metric-card">
                        <h4>Tickets Abiertos</h4>
                        <div class="value" id="kpiOpen">0</div>
                        <div class="label">En proceso</div>
                    </div>
                    <div class="metric-card">
                        <h4>Tasa de Resoluci√≥n</h4>
                        <div class="value" id="kpiResolutionRate">0%</div>
                        <div class="label">Efectividad</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Desglose por Criticidad</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-item alta">
                            <h5>Prioridad Alta</h5>
                            <div class="value" id="kpiAltaCount">0</div>
                            <div class="percentage" id="kpiAltaPercent">0%</div>
                        </div>
                        <div class="breakdown-item media">
                            <h5>Prioridad Media</h5>
                            <div class="value" id="kpiMediaCount">0</div>
                            <div class="percentage" id="kpiMediaPercent">0%</div>
                        </div>
                        <div class="breakdown-item baja">
                            <h5>Prioridad Baja</h5>
                            <div class="value" id="kpiBajaCount">0</div>
                            <div class="percentage" id="kpiBajaPercent">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: An√°lisis de Tendencias -->
            <div class="tab-content" id="tab4">
                <div class="trend-cards">
                    <div class="trend-card">
                        <h4>Promedio Diario Creados</h4>
                        <div class="value" id="avgDailyCreated">0</div>
                        <div class="subtitle">tickets por d√≠a</div>
                    </div>
                    <div class="trend-card">
                        <h4>Promedio Diario Resueltos</h4>
                        <div class="value" id="avgDailyResolved">0</div>
                        <div class="subtitle">tickets por d√≠a</div>
                    </div>
                    <div class="trend-card">
                        <h4>D√≠a con M√°s Tickets</h4>
                        <div class="value" id="peakDay">--</div>
                        <div class="subtitle" id="peakDayCount">0 tickets</div>
                    </div>
                </div>

                <div class="heatmap-container">
                    <h3>Mapa de Calor: Volumen de Tickets por D√≠a y Hora</h3>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">
                        <span id="peakHourInfo">Hora pico: --</span>
                    </p>
                    <canvas id="heatmapCanvas" class="heatmap-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allTickets = [];
        let currentFilter = 'all';
        let recurrenceChart = null;
        let criticalityChart = null;

        // API Configuration
        const API_BASE = window.location.origin;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();

            // Search functionality
            document.getElementById('searchBox').addEventListener('input', function(e) {
                filterTickets(e.target.value);
            });

            // Year selector
            document.getElementById('yearSelector').addEventListener('change', function() {
                refreshData();
            });
        });

        function initializeApp() {
            refreshData();
        }

        async function refreshData() {
            const year = document.getElementById('yearSelector').value;
            const yearParam = year === 'all' ? '' : `?year=${year}`;

            updateLastUpdateTime();

            // Load all data
            await Promise.all([
                loadTickets(yearParam),
                loadRecurrence(yearParam),
                loadKPIs(yearParam),
                loadTrends(yearParam)
            ]);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${timeString}`;
        }

        async function loadTickets(yearParam) {
            try {
                const response = await fetch(`${API_BASE}/api/tickets${yearParam}`);
                const data = await response.json();
                allTickets = data.tickets || [];

                updateTicketStats();
                displayTickets(allTickets);
                updateCriticalityChart();
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsContainer').innerHTML =
                    '<div class="no-data">Error al cargar los tickets. Verifique que el servidor est√© en funcionamiento.</div>';
            }
        }

        function updateTicketStats() {
            const total = allTickets.length;
            const baja = allTickets.filter(t => (t.priority || 1) === 1).length;
            const media = allTickets.filter(t => (t.priority || 1) === 2).length;
            const alta = allTickets.filter(t => (t.priority || 1) === 3).length;

            document.getElementById('totalTickets').textContent = total;
            document.getElementById('bajaCount').textContent = baja;
            document.getElementById('mediaCount').textContent = media;
            document.getElementById('altaCount').textContent = alta;
        }

        function displayTickets(tickets) {
            const container = document.getElementById('ticketsContainer');

            if (tickets.length === 0) {
                container.innerHTML = '<div class="no-data">No se encontraron tickets</div>';
                return;
            }

            container.innerHTML = tickets.map(ticket => {
                const priority = ticket.priority || 1;
                const priorityText = priority === 3 ? 'alta' : (priority === 2 ? 'media' : 'baja');
                const priorityLabel = priority === 3 ? 'Alta' : (priority === 2 ? 'Media' : 'Baja');

                return `
                    <div class="ticket-card" data-priority="${priorityText}">
                        <div class="ticket-header">
                            <span class="ticket-id">#${ticket.id}</span>
                            <span class="ticket-priority ${priorityText}">${priorityLabel}</span>
                        </div>
                        <div class="ticket-subject">${ticket.subject || 'Sin asunto'}</div>
                        <div class="ticket-meta">
                            <span>üìÖ ${formatDate(ticket.created_at)}</span>
                            <span>üë§ ${ticket.requester_name || 'Desconocido'}</span>
                            <span>üìä ${ticket.status_name || 'Sin estado'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterByPriority(priority) {
            currentFilter = priority;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter tickets
            const searchTerm = document.getElementById('searchBox').value;
            filterTickets(searchTerm);
        }

        function filterTickets(searchTerm) {
            let filtered = allTickets;

            // Filter by priority
            if (currentFilter !== 'all') {
                const priorityMap = { 'baja': 1, 'media': 2, 'alta': 3 };
                filtered = filtered.filter(t => (t.priority || 1) === priorityMap[currentFilter]);
            }

            // Filter by search term
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(t =>
                    (t.subject || '').toLowerCase().includes(term) ||
                    (t.description_text || '').toLowerCase().includes(term) ||
                    String(t.id).includes(term)
                );
            }

            displayTickets(filtered);
        }

        async function loadRecurrence(yearParam) {
            try {
                const response = await fetch(`${API_BASE}/api/recurrence${yearParam}`);
                const data = await response.json();

                updateRecurrenceChart(data.recurrence || []);
                updateRecurrenceTable(data.recurrence || []);
            } catch (error) {
                console.error('Error loading recurrence:', error);
            }
        }

        function updateRecurrenceChart(recurrenceData) {
            const ctx = document.getElementById('recurrenceChart').getContext('2d');

            // Take top 20
            const top20 = recurrenceData.slice(0, 20);

            if (recurrenceChart) {
                recurrenceChart.destroy();
            }

            recurrenceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top20.map(item => truncateText(item.subject, 30)),
                    datasets: [{
                        label: 'Cantidad de Tickets',
                        data: top20.map(item => item.count),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function updateRecurrenceTable(recurrenceData) {
            const tbody = document.getElementById('recurrenceTable').querySelector('tbody');

            if (recurrenceData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No hay datos de recurrencia</td></tr>';
                return;
            }

            const total = recurrenceData.reduce((sum, item) => sum + item.count, 0);

            tbody.innerHTML = recurrenceData.slice(0, 20).map((item, index) => {
                const percentage = ((item.count / total) * 100).toFixed(1);
                return `
                    <tr>
                        <td><span class="rank-badge">${index + 1}</span></td>
                        <td>${item.subject}</td>
                        <td><strong>${item.count}</strong></td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        function updateCriticalityChart() {
            const ctx = document.getElementById('criticalityChart').getContext('2d');

            const alta = allTickets.filter(t => (t.priority || 1) === 3).length;
            const media = allTickets.filter(t => (t.priority || 1) === 2).length;
            const baja = allTickets.filter(t => (t.priority || 1) === 1).length;
            const total = allTickets.length || 1;

            // Update cards
            document.getElementById('criticalityAltaCount').textContent = alta;
            document.getElementById('criticalityMediaCount').textContent = media;
            document.getElementById('criticalityBajaCount').textContent = baja;
            document.getElementById('criticalityAltaPercent').textContent = `${((alta/total)*100).toFixed(1)}%`;
            document.getElementById('criticalityMediaPercent').textContent = `${((media/total)*100).toFixed(1)}%`;
            document.getElementById('criticalityBajaPercent').textContent = `${((baja/total)*100).toFixed(1)}%`;

            if (criticalityChart) {
                criticalityChart.destroy();
            }

            criticalityChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Alta', 'Media', 'Baja'],
                    datasets: [{
                        data: [alta, media, baja],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadKPIs(yearParam) {
            try {
                const response = await fetch(`${API_BASE}/api/kpis${yearParam}`);
                const data = await response.json();

                const kpis = data.kpis || {};

                document.getElementById('kpiTotal').textContent = kpis.total || 0;
                document.getElementById('kpiClosed').textContent = kpis.closed || 0;
                document.getElementById('kpiOpen').textContent = kpis.open || 0;
                document.getElementById('kpiResolutionRate').textContent =
                    (kpis.resolution_rate || 0).toFixed(1) + '%';

                // Breakdown
                const breakdown = kpis.by_priority || {};
                document.getElementById('kpiAltaCount').textContent = breakdown.alta || 0;
                document.getElementById('kpiMediaCount').textContent = breakdown.media || 0;
                document.getElementById('kpiBajaCount').textContent = breakdown.baja || 0;

                const total = kpis.total || 1;
                document.getElementById('kpiAltaPercent').textContent =
                    (((breakdown.alta || 0) / total) * 100).toFixed(1) + '%';
                document.getElementById('kpiMediaPercent').textContent =
                    (((breakdown.media || 0) / total) * 100).toFixed(1) + '%';
                document.getElementById('kpiBajaPercent').textContent =
                    (((breakdown.baja || 0) / total) * 100).toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        async function loadTrends(yearParam) {
            try {
                const response = await fetch(`${API_BASE}/api/trends${yearParam}`);
                const data = await response.json();

                const trends = data.trends || {};

                document.getElementById('avgDailyCreated').textContent =
                    (trends.avg_daily_created || 0).toFixed(1);
                document.getElementById('avgDailyResolved').textContent =
                    (trends.avg_daily_resolved || 0).toFixed(1);

                if (trends.peak_day) {
                    document.getElementById('peakDay').textContent =
                        formatDateShort(trends.peak_day.date);
                    document.getElementById('peakDayCount').textContent =
                        `${trends.peak_day.count} tickets`;
                }

                // Heatmap
                if (trends.heatmap) {
                    drawHeatmap(trends.heatmap);

                    if (trends.peak_hour) {
                        document.getElementById('peakHourInfo').textContent =
                            `Hora pico: ${trends.peak_hour.day} a las ${trends.peak_hour.hour}:00 (${trends.peak_hour.count} tickets)`;
                    }
                }
            } catch (error) {
                console.error('Error loading trends:', error);
            }
        }

        function drawHeatmap(heatmapData) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            const hours = 24;

            const cellWidth = (canvas.width - 50) / hours;
            const cellHeight = (canvas.height - 40) / 7;

            // Find max value for color scaling
            let maxValue = 0;
            Object.values(heatmapData).forEach(dayData => {
                Object.values(dayData).forEach(count => {
                    if (count > maxValue) maxValue = count;
                });
            });

            // Draw cells
            for (let day = 0; day < 7; day++) {
                const dayName = days[day];

                // Draw day label
                ctx.fillStyle = '#1e293b';
                ctx.font = '12px Segoe UI';
                ctx.textAlign = 'right';
                ctx.fillText(dayName, 40, day * cellHeight + cellHeight/2 + 40);

                for (let hour = 0; hour < hours; hour++) {
                    const count = (heatmapData[dayName] && heatmapData[dayName][hour]) || 0;
                    const intensity = maxValue > 0 ? count / maxValue : 0;

                    // Color gradient from light to dark purple
                    const r = Math.floor(102 + (255 - 102) * (1 - intensity));
                    const g = Math.floor(126 + (255 - 126) * (1 - intensity));
                    const b = Math.floor(234 + (255 - 234) * (1 - intensity));

                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(
                        50 + hour * cellWidth,
                        30 + day * cellHeight,
                        cellWidth - 1,
                        cellHeight - 1
                    );

                    // Draw count if not zero
                    if (count > 0) {
                        ctx.fillStyle = intensity > 0.5 ? 'white' : '#333';
                        ctx.font = '10px Segoe UI';
                        ctx.textAlign = 'center';
                        ctx.fillText(
                            count,
                            50 + hour * cellWidth + cellWidth/2,
                            30 + day * cellHeight + cellHeight/2 + 3
                        );
                    }
                }
            }

            // Draw hour labels
            ctx.fillStyle = '#1e293b';
            ctx.font = '10px Segoe UI';
            ctx.textAlign = 'center';
            for (let hour = 0; hour < hours; hour += 2) {
                ctx.fillText(
                    hour + 'h',
                    50 + hour * cellWidth + cellWidth/2,
                    20
                );
            }
        }

        function switchTab(tabIndex) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach((content, index) => {
                if (index === tabIndex) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatDateShort(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                month: 'short',
                day: 'numeric'
            });
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
    </script>
</body>
</html>